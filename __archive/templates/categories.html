{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-2">
        <h2 class="h4 mb-0">ðŸ“‚ Category Management</h2>
        <a href="{{ url_for('create_box_form') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Create Box
        </a>
    </div>

    <!-- Add New Category Section -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Category</h5>
        </div>
        <div class="card-body">
            <form id="addCategoryForm" class="row g-3">
                <div class="col-12 col-md-8">
                    <label for="newCategoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control form-control-lg" id="newCategoryName" 
                           placeholder="e.g., Shoe Rack, Cupboard in Kitchen" required>
                    <small class="text-muted">Enter a descriptive name for the new category</small>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-plus-circle"></i> Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Categories -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Existing Categories</h5>
        </div>
        <div class="card-body p-0">
            {% if categories %}
            <div class="d-block d-md-none">
                {% for category in categories %}
                <div class="card m-3 border">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 fw-bold">{{ category.name }}</h6>
                            <div class="d-flex gap-2">
                                <!-- Edit button -->
                                <button class="btn btn-outline-primary btn-sm edit-category-btn" 
                                        data-category-id="{{ category.id }}"
                                        data-category-name="{{ category.name }}"
                                        title="Edit category name"
                                        style="min-height: 44px; min-width: 44px;">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                
                                <!-- Delete button -->
                                {% if category.can_delete %}
                                <button class="btn btn-outline-danger btn-sm delete-category-btn" 
                                        data-category-id="{{ category.id }}"
                                        data-category-name="{{ category.name }}"
                                        title="Delete category"
                                        style="min-height: 44px; min-width: 44px;">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-outline-secondary btn-sm" disabled
                                        title="Cannot delete - category is in use"
                                        style="min-height: 44px; min-width: 44px;">
                                    <i class="bi bi-lock"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted d-block">Boxes Using:</small>
                                {% if category.usage_count > 0 %}
                                <a href="{{ url_for('list_boxes') }}?category={{ category.name|urlencode }}" 
                                   class="badge bg-primary text-decoration-none">
                                    {{ category.usage_count }} box{% if category.usage_count != 1 %}es{% endif %}
                                </a>
                                {% else %}
                                <span class="badge bg-secondary">0 boxes</span>
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Created:</small>
                                <small class="text-muted">{{ category.created_at.split('T')[0] if 'T' in (category.created_at or '') else (category.created_at or '').split(' ')[0] }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category Name</th>
                                <th class="text-center">Boxes Using</th>
                                <th class="text-center">Created</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in categories %}
                            <tr>
                                <td>
                                    <strong>{{ category.name }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if category.usage_count > 0 %}
                                    <a href="{{ url_for('list_boxes') }}?category={{ category.name|urlencode }}" 
                                       class="badge bg-primary text-decoration-none">
                                        {{ category.usage_count }} box{% if category.usage_count != 1 %}es{% endif %}
                                    </a>
                                    {% else %}
                                    <span class="badge bg-secondary">0 boxes</span>
                                    {% endif %}
                                </td>
                                <td class="text-center text-muted">
                                    <small>{{ category.created_at.split('T')[0] if 'T' in (category.created_at or '') else (category.created_at or '').split(' ')[0] }}</small>
                                </td>
                                <td class="text-center">
                                    <!-- Edit button -->
                                    <button class="btn btn-outline-primary btn-sm edit-category-btn" 
                                            data-category-id="{{ category.id }}"
                                            data-category-name="{{ category.name }}"
                                            title="Edit category name">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <!-- Delete button -->
                                    {% if category.can_delete %}
                                    <button class="btn btn-outline-danger btn-sm delete-category-btn" 
                                            data-category-id="{{ category.id }}"
                                            data-category-name="{{ category.name }}"
                                            title="Delete category">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-sm" disabled
                                            title="Cannot delete - category is in use">
                                        <i class="bi bi-lock"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4 text-muted">
                <i class="bi bi-folder-x display-1"></i>
                <h5>No categories found</h5>
                <p>Add your first category above to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Help Section -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Category Management Tips</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="bi bi-plus-square text-success"></i> Adding Categories</h6>
                    <ul class="small">
                        <li>Categories are created automatically when you create boxes</li>
                        <li>You can also add them here for convenience</li>
                        <li>Use descriptive names like "Kitchen Pantry" or "Garage Tools"</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-pencil text-primary"></i> Editing Categories</h6>
                    <ul class="small">
                        <li>Click the pencil icon to edit any category name</li>
                        <li><strong>All boxes</strong> using that category will be automatically updated</li>
                        <li>Avoid using names that already exist</li>
                        <li>Editing is especially useful for fixing typos or improving descriptions</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-trash text-danger"></i> Deleting Categories</h6>
                    <ul class="small">
                        <li>You can only delete categories not in use</li>
                        <li>Click the box count to see which boxes use a category</li>
                        <li>Move or delete those boxes first to delete the category</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm" class="needs-validation" novalidate>
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control form-control-lg" id="editCategoryName" 
                               placeholder="e.g., Shoe Rack, Cupboard in Kitchen" required>
                        <div class="invalid-feedback">
                            Please enter a category name
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> Editing a category name will update all boxes using this category.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditCategoryBtn">
                    <i class="bi bi-check-circle"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Add new category functionality
document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const nameInput = document.getElementById('newCategoryName');
    const name = nameInput.value.trim();
    
    if (!name) {
        alert('Please enter a category name');
        return;
    }
    
    // Disable form during submission
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
    
    // Submit via fetch
    fetch('/api/categories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'name=' + encodeURIComponent(name)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - reload page to show new category
            window.location.reload();
        } else {
            if (data.error && data.error.includes('already exists')) {
                alert('Error category already exists!: Not adding');
            } else {
                alert(data.error || 'Unknown error occurred.');
            }
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('Error: Network or server issue. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

// Delete category functionality using event delegation
// No Bootstrap Modal initialization needed - using our custom implementation

// Handle edit button clicks
document.addEventListener('click', function(e) {
    // Edit category button handler
    if (e.target.closest('.edit-category-btn')) {
        const btn = e.target.closest('.edit-category-btn');
        const categoryId = btn.dataset.categoryId;
        const categoryName = btn.dataset.categoryName;
        
        // Set the values in the edit modal
        document.getElementById('editCategoryId').value = categoryId;
        document.getElementById('editCategoryName').value = categoryName;
        
        // Show the modal manually in case Bootstrap JS isn't available
        const modal = document.getElementById('editCategoryModal');
        modal.classList.add('show');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
    }
    
    // Delete category button handler
    if (e.target.closest('.delete-category-btn')) {
        const btn = e.target.closest('.delete-category-btn');
        const categoryId = btn.dataset.categoryId;
        const categoryName = btn.dataset.categoryName;
        
        if (!confirm('Are you sure you want to delete the category "' + categoryName + '"?\n\nThis action cannot be undone.')) {
            return;
        }
        
        fetch('/api/categories/' + categoryId, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success - reload page to show updated list
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting category: ' + error);
        });
    }
});

// Close modal function - reusable
function closeEditModal() {
    const modal = document.getElementById('editCategoryModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // Remove backdrop
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.parentNode.removeChild(backdrop);
    }
}

// Add event listeners for close buttons in the modal
document.addEventListener('click', function(e) {
    // Close modal when clicking close button or cancel button
    if (e.target.closest('[data-bs-dismiss="modal"]')) {
        closeEditModal();
    }
    
    // Close modal when clicking outside the modal content
    if (e.target.classList.contains('modal') && e.target.classList.contains('show')) {
        closeEditModal();
    }
});

// Handle escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.querySelector('.modal.show')) {
        closeEditModal();
    }
});

// Handle edit category form submission
document.getElementById('saveEditCategoryBtn').addEventListener('click', function() {
    const form = document.getElementById('editCategoryForm');
    
    // Validate the form
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    const categoryId = document.getElementById('editCategoryId').value;
    const newName = document.getElementById('editCategoryName').value.trim();
    
    // Show loading state
    const saveBtn = this;
    const originalContent = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    saveBtn.disabled = true;
    
    // Send the update request
    fetch('/api/categories/' + categoryId, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        // Reset button state
        saveBtn.innerHTML = originalContent;
        saveBtn.disabled = false;
        
        if (data.success) {
            // Show success message and reload
            const message = data.message || 'Category updated successfully';
            
            // Hide the modal
            closeEditModal();
            
            // Show a success message
            alert(message);
            
            // Reload the page to show updated data
            window.location.reload();
        } else {
            // Show error
            if (data.error && data.error.includes('already exists')) {
                alert('Error category already exists!: Not adding');
            } else {
                alert(data.error || 'Unknown error occurred.');
            }
        }
    })
    .catch(error => {
        // Reset button state
        saveBtn.innerHTML = originalContent;
        saveBtn.disabled = false;
        
        // Show error
        alert('Error: Network or server issue. Please try again.');
    });
});

// Make the interface mobile-friendly
document.addEventListener('DOMContentLoaded', function() {
    // Make table cells vertically centered (desktop only)
    document.querySelectorAll('th, td').forEach(function(cell) {
        cell.classList.add('align-middle');
    });
    
    // Ensure all buttons have proper touch targets for mobile
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        // Apply minimum touch target size for mobile
        if (window.innerWidth <= 768) {
            btn.style.minHeight = '44px';
            btn.style.minWidth = '44px';
        }
        
        // For small buttons, ensure they're touch-friendly
        if (btn.classList.contains('btn-sm')) {
            btn.style.minHeight = '44px';
            if (window.innerWidth <= 768) {
                btn.style.minWidth = '44px';
            }
        }
    });
    
    // Auto-focus the add category input on desktop only
    if (window.innerWidth > 768) {
        const categoryInput = document.getElementById('newCategoryName');
        if (categoryInput) {
            categoryInput.focus();
        }
    }
    
    // Add touch-friendly spacing for mobile cards
    if (window.innerWidth <= 768) {
        const mobileCards = document.querySelectorAll('.d-block.d-md-none .card');
        mobileCards.forEach(card => {
            card.style.marginBottom = '1rem';
        });
    }
    
    // Handle window resize to adjust button sizes
    window.addEventListener('resize', function() {
        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(btn => {
            if (window.innerWidth <= 768) {
                btn.style.minHeight = '44px';
                if (btn.classList.contains('btn-sm')) {
                    btn.style.minWidth = '44px';
                }
            } else {
                // Reset to default on larger screens
                if (!btn.classList.contains('btn-sm')) {
                    btn.style.minHeight = '';
                    btn.style.minWidth = '';
                }
            }
        });
    });
});
</script>
{% endblock %}
